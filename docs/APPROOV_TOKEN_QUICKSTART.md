# Approov Token Quickstart

This quickstart is for developers familiar with Swift who are looking for a quick intro into how they can add [Approov](https://approov.io) into an existing project. Therefore this will guide you through the necessary steps for adding Approov to an existing Swift Vapor API server.

## TOC - Table of Contents

* [Why?](#why)
* [How it Works?](#how-it-works)
* [Requirements](#requirements)
* [Approov Setup](#approov-setup)
* [Approov Token Check](#approov-token-check)
* [Try the Approov Integration Example](#try-the-approov-integration-example)


## Why?

To lock down your API server to your mobile app. Please read the brief summary in the [Approov Overview](/OVERVIEW.md#why) at the root of this repo or visit our [website](https://approov.io/product) for more details.

[TOC](#toc---table-of-contents)


## How it works?

For more background, see the [Approov Overview](/OVERVIEW.md#how-it-works) at the root of this repo.

The main functionality for the Approov token check is in the file [ApproovTokenMiddleware.swift](/src/approov-protected-server/token-check/hello/Sources/App/Middlewares/ApproovTokenMiddleware.swift). Take a look at the `verifyApproovToken()` function to see the simple code for the check.

[TOC](#toc---table-of-contents)


## Requirements

To complete this quickstart you will need both the Swift with Vapor toolbox and the Approov CLI tool installed.

* Swift:
    + [Linux](https://docs.vapor.codes/4.0/install/linux/)
    + [macOS](https://docs.vapor.codes/4.0/install/macos/)
* Approov CLI - Follow our [installation instructions](https://approov.io/docs/latest/approov-installation/#approov-tool) and read more about each command and its options in the [documentation reference](https://approov.io/docs/latest/approov-cli-tool-reference/)

[TOC](#toc---table-of-contents)


## Approov Setup

To use Approov with the Swift Vapor API server we need a small amount of configuration. First, Approov needs to know the API domain that will be protected. Second, the Swift Vapor API server needs the Approov Base64 encoded secret that will be used to verify the tokens generated by the Approov cloud service.

### Configure API Domain

Approov needs to know the domain name of the API for which it will issue tokens.

Add it with:

```bash
approov api -add your.api.domain.com
```

Adding the API domain also configures the [dynamic certificate pinning](https://approov.io/docs/latest/approov-usage-documentation/#approov-dynamic-pinning) setup, out of the box.

> **NOTE:** By default the pin is extracted from the public key of the leaf certificate served by the domain, as visible to the box executing the Approov CLI command and the Approov servers.

### Approov Secret

Approov tokens are signed with a symmetric secret. To verify tokens, we need to grab the secret using the [Approov secret command](https://approov.io/docs/latest/approov-cli-tool-reference/#secret-command) and plug it into the Swift Vapor API server environment to check the signatures of the [Approov Tokens](https://www.approov.io/docs/latest/approov-usage-documentation/#approov-tokens) that it processes.

First, enable your Approov `admin` role with:

```bash
eval `approov role admin`
````

Now, retrieve the Approov secret with:

```bash
approov secret -get base64
```

#### Set the Approov Secret

Open the `.env` file and add the Approov secret to the var:

```bash
APPROOV_BASE64_SECRET=approov_base64_secret_here
```

[TOC](#toc---table-of-contents)


## Approov Token Check

To check the Approov token we will use the [vapor/jwt](https://github.com/vapor/jwt) and [vapor/jwt-kit](https://github.com/vapor/jwt-kit) packages. The former is used to register the Approov middleware in the Vapor application while the later is used to perform the actual check.

Add the [ApproovTokenMiddleware.swift](src/approov-protected-server/token-check/hello/Sources/App/Middlewares/ApproovTokenMiddleware.swift) to your Vapor project:

```swift
import Vapor

// Using JWTKit because the JWT package assumes the token has the prefix `Bearer`.
import JWTKit

struct ApproovJWTPayload: JWTPayload {
    // Maps the longer Swift property names to the shortened keys used in the
    // JWT payload.
    enum CodingKeys: String, CodingKey {
        case expiration = "exp"
    }

    var expiration: ExpirationClaim

    // Run any additional verification logic beyond signature verification here.
    // Since we have an ExpirationClaim, we will call its verify method.
    func verify(using signer: JWTSigner) throws {
        try self.expiration.verifyNotExpired()
    }
}

final class ApproovTokenMiddleware: Middleware {
    public func respond(to request: Request, chainingTo next: Responder) -> EventLoopFuture<Response> {
        let approov_token_claims = verifyApproovToken(in: request)

        if approov_token_claims == nil {
            // You may want to add some logging here
            return request.eventLoop.makeFailedFuture(Abort(.unauthorized))
        }

        return next.respond(to: request)
    }

    private func verifyApproovToken(in request: Request) -> ApproovJWTPayload? {
        if request.headers["Approov-Token"].isEmpty {
            // You may want to add some logging here
            return nil
        }

        let approov_token = request.headers["Approov-Token"][0]

        // Returns `nil` when the token signature is invalid or has expired.
        return try? request.application.jwt.signers.verify(approov_token, as: ApproovJWTPayload.self)
    }
}
```

Register it in the Vapor application configuration, in the file [configure.swift](src/approov-protected-server/token-check/hello/Sources/App/configure.swift):

```swift
import Vapor
import JWT

// configures your application
public func configure(_ app: Application) throws {
    // register the Approov middleware for all routes.
    try registerApproovMiddleware(app)

    // register routes
    try routes(app)
}

private func registerApproovMiddleware(_ app: Application) throws {
    let secret: String = Environment.get("APPROOV_BASE64_SECRET") ?? ""
    let approov_base64_secret: String = secret.trimmingCharacters(in: .whitespacesAndNewlines)

    if approov_base64_secret == "" {
        throw Abort(.internalServerError, reason: "Missing value for the environment variable APPROOV_BASE64_SECRET")
    }

    let approov_secret: Data? = Data(base64Encoded: approov_base64_secret)

    if approov_secret == nil {
        throw Abort(.internalServerError, reason: "The value in APPROOV_BASE64_SECRET env var is not a valid base64 encoded string.")
    }

    app.jwt.signers.use(.hs256(key: approov_secret!))
    app.middleware.use(ApproovTokenMiddleware())
}
```

> **NOTE:** When the Approov token validation fails we return a `401` with an empty body, because we don't want to give clues to an attacker about the reason the request failed, and you can go even further by returning a `400`.

A full working example for a simple Hello World Swift Vapor API server can be found at [src/approov-protected-server/token-check/hello](/src/approov-protected-server/token-check/hello).

[TOC](#toc---table-of-contents)


## Test your Approov Integration

The following examples below use cURL, but you can also use the [Postman Collection](/README.md#testing-with-postman) to make the API requests. Just remember that you need to adjust the urls and tokens defined in the collection to match your deployment. Alternatively, the [README](/TESTING.md#the-dummy-secret) at the root of this repo also contains instructions for using the preset _dummy_ secret to test your Approov integration.

#### With Valid Approov Tokens

Generate a valid token example from the Approov Cloud service:

```bash
approov token -genExample your.api.domain.com
```

Then make the request with the generated token:

```bash
curl -i --request GET 'https://your.api.domain.com' \
  --header 'Approov-Token: APPROOV_TOKEN_EXAMPLE_HERE'
```

The request should be accepted. For example:

```text
HTTP/1.1 200 OK

...

{"message": "Hello, World!"}
```

#### With Invalid Approov Tokens

Generate an invalid token example from the Approov Cloud service:

```bash
approov token -type invalid -genExample your.api.domain.com
```

Then make the request with the generated token:

```bash
curl -i --request GET 'https://your.api.domain.com' \
  --header 'Approov-Token: APPROOV_INVALID_TOKEN_EXAMPLE_HERE'
```

The above request should fail with an Unauthorized error. For example:

```text
HTTP/1.1 401 Unauthorized

...

{}
```

[TOC](#toc---table-of-contents)


## Issues

If you find any issue while following our instructions then just report it [here](https://github.com/approov/quickstart-swift-vapor-token-check/issues), with the steps to reproduce it, and we will sort it out and/or guide you to the correct path.

[TOC](#toc---table-of-contents)


## Useful Links

If you wish to explore the Approov solution in more depth, then why not try one of the following links as a jumping off point:

* [Approov Free Trial](https://approov.io/signup)(no credit card needed)
* [Approov Get Started](https://approov.io/product/demo)
* [Approov QuickStarts](https://approov.io/docs/latest/approov-integration-examples/)
* [Approov Docs](https://approov.io/docs)
* [Approov Blog](https://approov.io/blog/)
* [Approov Resources](https://approov.io/resource/)
* [Approov Customer Stories](https://approov.io/customer)
* [Approov Support](https://approov.zendesk.com/hc/en-gb/requests/new)
* [About Us](https://approov.io/company)
* [Contact Us](https://approov.io/contact)

[TOC](#toc---table-of-contents)
